<div class="daohang">
    <ul>
        <li><button type="button" class="am-btn am-btn-default am-radius am-btn-xs"> 客户管理</button> </li>
        <li><button type="button" class="am-btn am-btn-default am-radius am-btn-xs"> 添加->更新->删除</button> </li>
    </ul>
</div>

<div class="admin-biaogelist">
    <table class="layui-table" id="LAY_table_user">

    </table>
    <script type="text/html" id="auditingStatus">
        <!-- 这里的 checked 的状态只是演示 -->

        {{ d.auditingStatus==2 ? '通过' : d.auditingStatus==1?'审核':"未上传" }}

    </script>
    <script type="text/html" id="depositSta">
        <!-- 这里的 checked 的状态只是演示 -->

        {{ d.depositSta==1 ? '已付押金' : '未付押金' }}

    </script>
    <script type="text/html" id="editClient">
        <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
    </script>
    <!-- 修改用户 -->
    <div style="display: none" id="edit_client_template">
        <form class="layui-form" action="" lay-filter="edit_client" style="margin:20px;">

            <!--客户名-->
            <div class="layui-form-item">
                <label class="layui-form-label">客户名</label>
                <div class="layui-input-block">
                    <input type="text" name="clientName" autocomplete="off" placeholder="请输入客户名" class="layui-input">
                </div>
            </div>
            <!--客户名-->
            <div class="layui-form-item">
                <label class="layui-form-label">客户代码</label>
                <div class="layui-input-block">
                    <input type="text" name="clientCode" autocomplete="off" placeholder="请输入客户客户代码" class="layui-input">
                </div>
            </div>
            <!--驾驶证号-->
            <div class="layui-form-item">
                <label class="layui-form-label">驾驶证号</label>
                <div class="layui-input-block">
                    <input type="number" name="driverCode" autocomplete="off" placeholder="请输入驾驶证号" class="layui-input">
                </div>
            </div>
            <!--审核状态-->
            <div class="layui-form-item">
                <label class="layui-form-label">审核状态</label>
                <div class="layui-input-block">
                    <input type="radio" name="auditingStatus" value="0" title="未上传" checked="">
                    <input type="radio" name="auditingStatus" value="1" title="审核">
                    <input type="radio" name="auditingStatus" value="2" title="通过">
                </div>
            </div>
            <!--身份-->
            <div class="layui-form-item">
                <label class="layui-form-label">押金状态</label>
                <div class="layui-input-block">
                    <input type="radio" name="depositSta" value="0" title="未付押金" checked="">
                    <input type="radio" name="depositSta" value="1" title="已付押金">
                </div>
            </div>
            <div class="layui-form-item">
                <div style="text-align: center;">
                    <button class="layui-btn" lay-submit="" lay-filter="demo1" />立即提交</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    // 生成table
    layui.use('table', function() {
        var table = layui.table;
        //方法级渲染

        table.render({
            elem: '#LAY_table_user',
            url: '/user/showList',
            cols: [
                [{
                    field: 'id',
                    title: 'ID',
                    width: 80,
                    sort: true,
                }, {
                    field: 'clientName',
                    title: '客户名',
                    width: 180
                }, {
                    field: 'clientCode',
                    title: '客户代码',
                    width: 180
                }, {
                    field: 'driverCode',
                    title: '驾驶证号',
                    width: 180,
                    sort: true
                }, {
                    field: 'auditingStatus',
                    title: '审核状态',
                    templet: '#auditingStatus'
                }, {
                    field: 'depositSta',
                    title: '押金状态',
                    templet: '#depositSta'
                }, {
                    width: 178,
                    title: '操作',
                    align: 'center',
                    toolbar: '#editClient'
                }]
            ],
            id: 'testReload',
            page: true,
        });

        active = {
            reload: function() {
                var demoReload = $('#demoReload');

                //执行重载
                table.reload('testReload', {
                    page: {
                        curr: 1 //重新从第 1 页开始
                    },
                    where: {
                        key: {
                            id: demoReload.val()
                        }
                    }
                });
            }
        };


        //监听工具条
        table.on('tool', function(obj) {
            var data = obj.data;
            if (obj.event === 'del') {
                //执行删除
                layer.confirm('确认删除客户吗', function(index) {
                    console.log(data);
                    $.ajax({
                        url: "/user/delete?id=" + data.id,
                        type: "DELETE",
                        success: function(message) {
                            console.log(message);
                            // 关闭弹窗
                            layer.closeAll();
                            // 修改成功之后刷新
                            active['reload']();
                            layer.msg('删除成功');
                        },
                        error: function(data) {
                            layer.msg('出现错误');
                        }
                    })
                });
            } else if (obj.event === 'edit') {
                //执行修改
                // console.log(data);
                activePop('edit_client_template', data);
                // layer.alert('编辑行：<br>'+ JSON.stringify(data))
            }
        });
    });

    function setForm(initValue) {
        layui.use(['form'], function() {
            var form = layui.form
                //自定义验证规则
            form.verify({
                // title: function(value){
                //     if(value.length < 5){
                //         return '标题至少得5个字符啊';
                //     }
                // },
                pass: [/(.+){6,12}$/, '密码必须6到12位']
                    // ,content: function(value){
                    //     layedit.sync(editIndex);
                    // }
            });
            //监听提交
            form.on('submit(demo1)', function(data) {
                data.field.id = initValue.id;
                $.ajax({
                    url: "/user/update",
                    type: "PUT",
                    data: JSON.stringify(data.field),
                    contentType: "application/json",
                    dataType: 'json',
                    success: function(message) {
                        console.log(message);
                        // 关闭弹窗
                        layer.closeAll();
                        // 修改成功之后刷新
                        active['reload']();
                        layer.msg('修改成功');
                    },
                    error: function(data) {
                        layer.msg('出现错误');
                    }
                })
                return false;
            });
            // 防止status为数字类型，导致无法设置默认值
            initValue.auditingStatus = initValue.auditingStatus.toString();
            initValue.depositSta = initValue.depositSta.toString();
            //表单初始赋值
            console.log(initValue);
            if (initValue) {
                form.val('edit_client', initValue);
            }
        });
    }
    //触发事件
    function activePop(id, initValue) {
        layer.open({
            type: 1,
            area: ['500px', '450px'],
            content: document.getElementById(id).innerHTML //传入表单html
                // ,btn: '关闭全部'
                ,
            btnAlign: 'c' //按钮居中
                ,
            shade: 0 //不显示遮罩
                // ,yes: function(){
                //     layer.closeAll();
                // }
        });
        //打开后设置form
        setForm(initValue);
    }
</script>